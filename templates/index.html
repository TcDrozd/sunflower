{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>ðŸŒ» Upward Bound</h1>
        <p>A Season in the Life of Something Tall</p>
    </div>
    
    <!-- Upload Section -->
    <div class="upload-section">
        <h2 style="margin-bottom: 1rem;">Add New Photos</h2>
        <input type="file" id="photoInput" multiple accept="image/*" style="display: none;">
        <button class="btn" onclick="document.getElementById('photoInput').click();">
            ðŸ“¸ Upload Photos
        </button>
        <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
            Select one or more photos to add to your sunflower journal
        </p>
    </div>
    
    <!-- Photos Grid -->
    <div class="photo-grid">
        {% for photo in photos %}
        <div class="photo-card" onclick="showPhotoModal('{{ photo.id }}')">
            <img 
                class="lazy" 
                loading="lazy" 
                src="/thumbnails/{{ photo.thumbnail }}" 
                data-src="/thumbnails/preview_{{ photo.filename }}" 
                alt="Sunflower photo from {{ photo.date_taken or 'Unknown date' }}">
            <div class="photo-info">
                <div class="photo-date">
                    {% if photo.date_taken %}
                        {{ photo.date_taken }}
                        {% if photo.time_taken %} at {{ photo.time_taken }}{% endif %}
                    {% else %}
                        Uploaded: {{ photo.upload_date[:10] }}
                    {% endif %}
                </div>
                <div class="photo-filename">{{ photo.original_filename }}</div>
                {% if photo.camera_info.make or photo.camera_info.model %}
                <div class="photo-camera">
                    ðŸ“· {{ photo.camera_info.make or '' }} {{ photo.camera_info.model or '' }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        
        {% if not photos %}
        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h3 style="color: #666; margin-bottom: 1rem;">No photos yet! ðŸŒ±</h3>
            <p style="color: #888;">Upload your first sunflower photo to start your growth journal.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Upload Confirmation Modal -->
<div id="uploadModal" class="modal upload-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Confirm Photo Upload</h2>
            <span class="close" onclick="hideModal('uploadModal')">&times;</span>
        </div>
        <div class="modal-body">
            <div id="filePreview"></div>
            <div class="loading" id="uploadLoading">
                <div class="spinner"></div>
                <p>Uploading photos and extracting metadata...</p>
            </div>
            <div class="success-message" id="successMessage"></div>
            <div class="error-message" id="errorMessage"></div>
            <div style="text-align: right; margin-top: 1rem;">
                <button class="btn" onclick="hideModal('uploadModal')" style="margin-right: 1rem; background: #6c757d;">Cancel</button>
                <button class="btn" onclick="confirmUpload()" id="confirmUploadBtn">Upload Photos</button>
            </div>
        </div>
    </div>
</div>

<!-- Photo Detail Modal -->
<div id="photoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="photoModalTitle">Photo Details</h2>
            <span class="close" onclick="hideModal('photoModal')">&times;</span>
        </div>
        <div class="modal-body" id="photoModalBody">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

<script>
let selectedFiles = [];

// Handle file selection
document.getElementById('photoInput').addEventListener('change', function(e) {
    selectedFiles = Array.from(e.target.files);
    if (selectedFiles.length > 0) {
        showUploadPreview();
    }
});

function showUploadPreview() {
    const preview = document.getElementById('filePreview');
    preview.innerHTML = '<h3>Selected Photos:</h3>';
    
    selectedFiles.forEach((file, index) => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'file-preview';
        fileDiv.innerHTML = `
            <div class="file-info">
                <strong>ðŸ“· ${file.name}</strong> (${(file.size / 1024 / 1024).toFixed(2)} MB)
            </div>
            <div style="font-size: 0.9rem; color: #666;">
                Type: ${file.type} | Last modified: ${new Date(file.lastModified).toLocaleDateString()}
            </div>
        `;
        preview.appendChild(fileDiv);
    });
    
    showModal('uploadModal');
}

function confirmUpload() {
    if (selectedFiles.length === 0) return;
    
    // Show loading
    document.getElementById('uploadLoading').style.display = 'block';
    document.getElementById('confirmUploadBtn').style.display = 'none';
    document.getElementById('successMessage').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
    
    // Create form data
    const formData = new FormData();
    selectedFiles.forEach(file => {
        formData.append('photos', file);
    });
    
    // Upload photos
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('uploadLoading').style.display = 'none';
        
        if (data.success) {
            document.getElementById('successMessage').innerHTML = data.message;
            document.getElementById('successMessage').style.display = 'block';
            
            // Reload page after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            document.getElementById('errorMessage').innerHTML = data.error || 'Upload failed';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('confirmUploadBtn').style.display = 'inline-block';
        }
    })
    .catch(error => {
        document.getElementById('uploadLoading').style.display = 'none';
        document.getElementById('errorMessage').innerHTML = 'Network error: ' + error.message;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('confirmUploadBtn').style.display = 'inline-block';
    });
}

function showPhotoModal(photoId) {
    // Fetch photo details
    fetch(`/photo/${photoId}`)
    .then(response => response.json())
    .then(photo => {
        const title = photo.date_taken ? 
            `Photo from ${photo.date_taken}` : 
            `Photo: ${photo.original_filename}`;
        
        document.getElementById('photoModalTitle').textContent = title;
        
        let cameraInfo = '';
        if (photo.camera_info && Object.keys(photo.camera_info).length > 0) {
            cameraInfo = '<div class="exif-info"><h3>ðŸ“· Camera Information</h3><div class="exif-grid">';
            
            const cameraLabels = {
                'make': 'Camera Make',
                'model': 'Camera Model',
                'lens': 'Lens',
                'focal_length': 'Focal Length',
                'aperture': 'Aperture',
                'iso': 'ISO',
                'shutter_speed': 'Shutter Speed'
            };
            
            for (const [key, value] of Object.entries(photo.camera_info)) {
                if (value) {
                    const label = cameraLabels[key] || key.replace('_', ' ').toUpperCase();
                    cameraInfo += `
                        <div class="exif-item">
                            <span class="exif-label">${label}:</span>
                            <span class="exif-value">${value}</span>
                        </div>
                    `;
                }
            }
            cameraInfo += '</div></div>';
        }
        
        const content = `
            <img src="/uploads/${photo.filename}" alt="Sunflower photo" class="modal-image">
            <div style="margin-bottom: 1rem;">
                <h3>${photo.original_filename}</h3>
                <p><strong>ðŸ“… Date Taken:</strong> ${photo.date_taken || 'Unknown'} ${photo.time_taken ? 'at ' + photo.time_taken : ''}</p>
                <p><strong>ðŸ“¤ Uploaded:</strong> ${new Date(photo.upload_date).toLocaleDateString()}</p>
            </div>
            ${cameraInfo}
        `;
        
        document.getElementById('photoModalBody').innerHTML = content;
        showModal('photoModal');
    })
    .catch(error => {
        console.error('Error loading photo details:', error);
        document.getElementById('photoModalBody').innerHTML = '<p>Error loading photo details.</p>';
        showModal('photoModal');
    });
}
</script>
{% endblock %}
